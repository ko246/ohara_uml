@startuml
title 図書返却処理シーケンス図 (Uターン完全排除版)

' 1. アクター (Actor: 1)
actor 事務職員 as ユーザー

' 2. 境界オブジェクト (Boundary: 2)
boundary 返却一覧画面
boundary 返却完了画面

' 3. 制御オブジェクト (Control: 既存3 + 追加3 = 6)
control 画面表示制御 
control 図書確認
control 返却更新処理
control メール確認処理
control メッセージ表示制御 
control 完了画面表示制御 

' 4. 実態オブジェクト (Entity: 2)
entity 貸出情報
entity 予約情報

' ----------------------------------
' 返却処理シーケンス
' ----------------------------------

' 1. 返却メニューを押す (唯一のアクター操作)
ユーザー -> 返却一覧画面 : 返却メニューを押す
activate 返却一覧画面

' 2. 管理番号の入力を促す (画面表示制御を経由)
返却一覧画面 -> 画面表示制御 : 入力待ち画面表示指示
activate 画面表示制御
画面表示制御 --> 返却一覧画面 : "管理番号を確認してください" を表示
deactivate 画面表示制御

' 3. 管理番号入力後、図書確認へ処理を委譲
返却一覧画面 -> 図書確認 : 管理番号を渡す
activate 図書確認

' 貸出情報の確認
図書確認 -> 貸出情報 : 貸出状況の問い合わせ
activate 貸出情報
貸出情報 --> 図書確認 : 貸出情報の結果を返却
deactivate 貸出情報

alt 貸出中でなかった場合 (代替フロー ③)
    ' 画面表示制御を経由してメッセージを表示
    図書確認 -> 画面表示制御 : "貸し出されていません"表示指示
    activate 画面表示制御
    画面表示制御 --> 返却一覧画面 : メッセージを表示
    deactivate 画面表示制御
    deactivate 図書確認
    
else 貸出情報が存在した場合
    
    alt 返却期限が過ぎている場合 (代替フロー ②)
        ' 画面表示制御を経由して警告を表示
        図書確認 -> 画面表示制御 : 期限超過警告表示指示
        activate 画面表示制御
        画面表示制御 --> 返却一覧画面 : 警告を表示
        deactivate 画面表示制御
    end
    
    ' 図書情報を一覧に追加
    図書確認 --> 返却一覧画面 : 図書情報の一覧への追加指示
    deactivate 図書確認
    
    ' 4. 返却ボタンを押下後、更新処理へ移行
     返却一覧画面 -> 返却更新処理 : 返却対象図書情報
    deactivate 返却一覧画面 
    activate 返却更新処理

    alt 返却する図書が一つも入力されていなかった場合 (代替フロー ④)
        ' メッセージ表示制御を経由してエラーを表示
        返却更新処理 -> 画面表示制御 : "図書が入力されていません"表示指示
        activate 画面表示制御
        画面表示制御 --> 返却一覧画面 : メッセージを表示
        deactivate 画面表示制御
        deactivate 返却更新処理
        
    else 返却対象図書があった場合
        
        ' 5. DB更新
        返却更新処理 -> 貸出情報 : 貸出状況を更新(返却済みに)
        
        ' メール確認処理へ
        返却更新処理 -> メール確認処理 : 予約確認を開始
        activate メール確認処理
        
        メール確認処理 -> 予約情報 : 予約の有無を確認
        activate 予約情報
        予約情報 --> メール確認処理 : 予約情報の結果
        deactivate 予約情報

        alt 予約済みの場合 (代替フロー ⑤)
            ' メッセージ表示制御を経由し、メール送信処理を実行
            メール確認処理 -> メッセージ表示制御 : 通知メール送信処理指示
            activate メッセージ表示制御
            deactivate メッセージ表示制御
        end
        
        メール確認処理 --> 返却更新処理 : 予約処理完了通知
        deactivate メール確認処理
        
        ' 6. 返却完了画面へ遷移 (完了画面表示制御を経由)
        返却更新処理 -> 完了画面表示制御 : 完了メッセージ表示指示
        deactivate 返却更新処理
        
        activate 完了画面表示制御
        完了画面表示制御 -> 返却完了画面 : 返却完了画面を表示
        deactivate 完了画面表示制御
        
        activate 返却完了画面
        deactivate 返却完了画面
    end
end
@enduml