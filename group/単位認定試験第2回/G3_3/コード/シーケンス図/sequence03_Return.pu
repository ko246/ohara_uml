@startuml
title 図書返却シーケンス図

' 1. アクター
actor 事務職員 as ユーザー

' 2. 境界オブジェクト
boundary 返却一覧画面
boundary 返却完了画面

' 3. 制御オブジェクト
control 画面表示制御 
control 図書確認
control 返却更新処理
control メール確認処理
control メッセージ表示制御 
control 完了画面表示制御 

' 4. 実態オブジェクト
entity 貸出情報
entity 予約情報

' ----------------------------------
' 返却処理シーケンス
' ----------------------------------

' 1. 返却メニューを押す
ユーザー -> 返却一覧画面 : 返却メニューを押す()
activate 返却一覧画面

' 2. 画面表示制御による入力促しと表示
返却一覧画面 -> 画面表示制御 : 入力待ち画面表示指示()
activate 画面表示制御
画面表示制御 --> 返却一覧画面 : "管理番号を確認してください" を表示()
deactivate 画面表示制御

' 3. 図書確認と貸出情報の問い合わせ
返却一覧画面 -> 図書確認 : 管理番号を渡す()
activate 図書確認

図書確認 -> 貸出情報 : 貸出状況の問い合わせ()
activate 貸出情報
貸出情報 --> 図書確認 : 貸出情報の結果を返却()
deactivate 貸出情報

alt 管理番号が登録されていた場合
    
    ' 代替フロー ②: 返却期限超過のチェック (警告のみ)
    alt 図書の返却期限が過ぎていた場合
        ' 期限超過警告表示 (代替処理)
        図書確認 -> 画面表示制御 : "返却期限が過ぎています"表示指示()
        activate 画面表示制御
        画面表示制御 --> 返却一覧画面 : 警告を表示()
        deactivate 画面表示制御
    else 期限内であった場合
        ' 何もせず処理を継続 (基本フロー)
    end
    
    ' 図書情報を一覧に追加 (基本フローの継続)
    図書確認 --> 返却一覧画面 : 図書情報の一覧への追加指示()
    deactivate 図書確認
    
    ' 4. 返却更新処理へ移行
    返却一覧画面 -> 返却更新処理 : 返却対象図書情報()
    deactivate 返却一覧画面 
    activate 返却更新処理

    alt 返却対象図書が入力されていた場合
        
        ' 5. DB更新
        返却更新処理 -> 貸出情報 : 貸出状況を返却済みに更新()
        
        ' メール確認処理へ
        返却更新処理 -> メール確認処理 : 予約確認を開始()
        activate メール確認処理
        
        メール確認処理 -> 予約情報 : 予約の有無を確認()
        activate 予約情報
        予約情報 --> メール確認処理 : 予約情報の結果()
        deactivate 予約情報

        ' 代替フロー ⑤: 予約ありのチェック (処理の追加)
        alt 図書が予約されていた場合
            ' 通知メール送信処理 (代替処理)
            メール確認処理 -> メッセージ表示制御 : 通知メール送信処理指示()
            activate メッセージ表示制御
            deactivate メッセージ表示制御
        end
        
        メール確認処理 --> 返却更新処理 : 予約処理完了通知()
        deactivate メール確認処理
        
        ' 6. 返却完了画面へ遷移
        返却更新処理 -> 完了画面表示制御 : 完了メッセージ表示指示()
        deactivate 返却更新処理
        
        activate 完了画面表示制御
        完了画面表示制御 -> 返却完了画面 : 返却完了画面を表示()
        deactivate 完了画面表示制御
        
        activate 返却完了画面
        deactivate 返却完了画面
        
    else 返却する図書が一つも入力されなかった場合
        ' 代替フロー ④: 入力不足エラー表示 (処理の中断)
        返却更新処理 -> 画面表示制御 : "図書が入力されていません"表示指示()
        activate 画面表示制御
        画面表示制御 --> 返却一覧画面 : メッセージを表示()
        deactivate 画面表示制御
        deactivate 返却更新処理
    end
    
else 管理番号が登録されていなかった場合
    ' 代替フロー ①: 未登録メッセージ表示 (処理の中断)
    図書確認 -> 画面表示制御 : "貸し出されていません"表示指示()
    activate 画面表示制御
    画面表示制御 --> 返却一覧画面 : メッセージを表示()
    deactivate 画面表示制御
    deactivate 図書確認
end
@enduml